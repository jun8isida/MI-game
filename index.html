<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ケースワーカーのためのMIトレーニングゲーム</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --bg-color: #e6ebee;
            --chat-bg: #ffffff;
            --client-bubble: #f0f0f0;
            --player-bubble: #8de055;
            --feedback-bubble: #fffbe6;
            --feedback-border: #ffe58f;
            --system-bubble: #e6f7ff;
            --system-border: #91d5ff;
            --button-bg: #007bff;
            --button-hover-bg: #0056b3;
            --secondary-button-bg: #6c757d;
            --secondary-button-hover-bg: #5a6268;
            --quiz-button-bg: #28a745;
            --quiz-button-hover-bg: #218838;
            --correct-bg: #e6ffed;
            --correct-border: #b7eb8f;
            --incorrect-bg: #fff1f0;
            --incorrect-border: #ffa39e;
            --text-dark: #333;
            --text-light: #ffffff;
            --border-radius: 12px;
            --accordion-bg: #f8f9fa;
            --accordion-border: #dee2e6;
        }

        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-dark);
            box-sizing: border-box;
        }

        .game-container {
            width: 100%;
            max-width: 420px;
            height: 90vh;
            max-height: 800px;
            background-color: var(--chat-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #scenario-selector {
            padding: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        #scenario-selector h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        #scenario-selector .top-image {
            width: 180px;
            margin-bottom: 20px;
        }

        #scenario-selector p {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
        }

        .scenario-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: linear-gradient(145deg, #4da1ff, #007bff);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .scenario-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .study-button {
            background: linear-gradient(145deg, #868e96, #495057);
        }

        .study-button:hover {
             box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        
        .quiz-button {
            background: linear-gradient(145deg, #34d058, var(--quiz-button-bg));
        }
        .quiz-button:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }


        #game-screen, #study-mode-screen, #quiz-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* 学習モードのスタイル */
        #study-mode-screen .header, #quiz-screen .header {
            flex-shrink: 0;
        }
        #study-content, #quiz-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* クイズ画面のスタイル */
        #quiz-question {
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--system-bubble);
            border-radius: 8px;
        }
        #quiz-options .option-button {
            margin-bottom: 10px;
        }
        #quiz-feedback {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            animation: fadeIn 0.3s ease-out;
        }
        #quiz-feedback.correct {
            background-color: var(--correct-bg);
            border: 1px solid var(--correct-border);
        }
        #quiz-feedback.incorrect {
            background-color: var(--incorrect-bg);
            border: 1px solid var(--incorrect-border);
        }
        #quiz-result {
            text-align: center;
            font-size: 18px;
        }
        #quiz-result h3 {
            margin-bottom: 10px;
        }
        #quiz-result p {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }


        .accordion-item {
            margin-bottom: 15px;
            border: 1px solid var(--accordion-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .accordion-header {
            background-color: var(--accordion-bg);
            padding: 15px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-header::after {
            content: '+';
            font-size: 24px;
            font-weight: 300;
            transition: transform 0.3s ease;
        }
        .accordion-item.active .accordion-header::after {
            transform: rotate(45deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background-color: #fff;
            font-size: 14px;
            line-height: 1.7;
        }
        .accordion-content .content-inner {
             padding: 15px;
        }
        .accordion-content ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        .accordion-content li {
            margin-bottom: 8px;
        }
         .accordion-content strong {
            color: var(--button-bg);
         }


        .header {
            padding: 10px 20px;
            background-color: #f7f7f7;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            font-size: 16px;
            margin: 0;
            font-weight: 500;
        }
        
        .back-button {
            padding: 5px 10px;
            background-color: var(--secondary-button-bg);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .back-button:hover {
            background-color: var(--secondary-button-hover-bg);
        }

        #score-display {
            font-size: 16px;
            font-weight: bold;
            color: var(--button-bg);
        }

        #chat-log {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            max-width: 85%;
            line-height: 1.5;
            animation: fadeIn 0.3s ease-out;
        }

        .message.client {
            background-color: var(--client-bubble);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .message.player {
            background-color: var(--player-bubble);
            color: var(--text-dark);
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .message.feedback {
            background-color: var(--feedback-bubble);
            border: 1px solid var(--feedback-border);
            align-self: center;
            width: 90%;
            font-size: 13px;
            margin-top: 5px;
            margin-bottom: 20px;
        }
        .feedback .mi-skill {
            font-weight: bold;
            color: #d46b08;
        }
        .feedback .score {
            font-weight: bold;
        }
        .feedback .score.plus { color: #389e0d; }
        .feedback .score.minus { color: #cf1322; }

        .message.system {
            background-color: var(--system-bubble);
            border: 1px solid var(--system-border);
            align-self: center;
            width: 90%;
            font-size: 13px;
            text-align: center;
        }

        #options-container {
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #f7f7f7;
            flex-shrink: 0;
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background-color: var(--chat-bg);
            color: var(--button-bg);
            border: 1px solid var(--button-bg);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .option-button:last-child {
            margin-bottom: 0;
        }

        .option-button:hover:not(:disabled) {
            background-color: var(--button-bg);
            color: var(--text-light);
        }

        .option-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>

    <div class="game-container">
        
        <!-- メインメニュー -->
        <div id="scenario-selector">
            <img src="images/top.png" alt="MIトレーニングイメージ" class="top-image">
            <div>
                <h1>MIトレーニング</h1>
                <p>動機付け面接のスキルを学びましょう。</p>
            </div>
            <div>
                <button class="scenario-button study-button" onclick="showStudyMode()">基本を学ぶ</button>
                <button class="scenario-button quiz-button" onclick="showQuizScreen()">用語クイズ</button>
                <button class="scenario-button" onclick="startRandomScenario()">シナリオを開始</button>
            </div>
        </div>

        <!-- 学習モード画面 -->
        <div id="study-mode-screen" class="hidden">
            <div class="header">
                <button class="back-button" onclick="showMainMenu()">戻る</button>
                <h2>MIの基本知識</h2>
                <span></span>
            </div>
            <div id="study-content">
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">関わり方の基本姿勢「PACE」</div>
                        <div class="accordion-content">
                            <div class="content-inner">
                                PACEは、動機付け面接の根底にある「精神」や「あり方」を示す4つの要素の頭文字です。スキルを使う以前の、相談者と向き合う基本姿勢となります。<br><br>
                                <ul>
                                    <li><strong>Partnership (協働):</strong> 支援者は「専門家」、相談者は「教えてもらう人」という関係ではなく、対等なパートナーとして、共に問題に取り組みます。</li>
                                    <li><strong>Acceptance (受容):</strong> 相手の価値観や選択を、無条件に尊重します。相手が持つ強さを信じ、共感的に関わります。</li>
                                    <li><strong>Compassion (思いやり):</strong> 相手の幸福と福祉を最優先に考え、相手のために行動します。</li>
                                    <li><strong>Evocation (喚起):</strong> 変化への動機や答えは、本人の中にすでにあると考えます。支援者の役割は、それを引き出すことです。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">コミュニケーションスキル「OARS」</div>
                        <div class="accordion-content">
                            <div class="content-inner">
                                OARSは、動機付け面接で中心的に使われる4つの基本的なコミュニケーションスキルの頭文字です。<br><br>
                                <ul>
                                    <li><strong>Open questions (開かれた質問):</strong> 「はい/いいえ」で終わらない質問を投げかけ、相手が自由に話せる空間を作ります。「...について、どう思いますか？」</li>
                                    <li><strong>Affirming (是認):</strong> 相手の長所、強み、努力、肯定的な側面を見つけて、言葉にして伝えます。相手の自信と自己効力感を高めます。「大変な中でも、よく考えていますね。」</li>
                                    <li><strong>Reflecting (聞き返し):</strong> 相手が話したことを、別の言葉で言い換えたり、感情を汲み取って返します。相手は「理解してもらえた」と感じ、さらに深く話せるようになります。「...ということなのですね。」</li>
                                    <li><strong>Summarizing (要約):</strong> 会話の内容をまとめ、相手に確認します。会話の方向性を確認したり、相手が話した「変わりたい」という言葉（チェンジトーク）を強調する効果があります。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">MIの４つのプロセス</div>
                        <div class="accordion-content">
                            <div class="content-inner">
                                動機付け面接は、大きく4つのプロセス（段階）を経て進んでいきます。前のプロセスが、次のプロセスの土台となります。<br><br>
                                <ol>
                                    <li><strong>関わる (Engaging):</strong> 支援者と相談者が、お互いに協力できるような信頼関係を築く段階です。安心できる雰囲気を作ることが最も重要です。</li>
                                    <li><strong>焦点化する (Focusing):</strong> 会話の中から、取り組むべき特定のテーマ（変化の目標）を見つけ出し、明確にしていく段階です。「今日は、何について話しましょうか？」</li>
                                    <li><strong>引き出す (Evoking):</strong> 変化に向けての、相談者自身の動機を引き出す段階です。MIの心臓部とも言える最も重要なプロセスです。相談者の口から「チェンジトーク」が語られるよう促します。</li>
                                    <li><strong>計画する (Planning):</strong> 変化への動機が十分に高まったら、具体的な行動計画を一緒に立てる段階です。いつ、どこで、何を、どのように行うかを話し合います。</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                     <div class="accordion-item">
                        <div class="accordion-header">チェンジトークの種類</div>
                        <div class="accordion-content">
                            <div class="content-inner">
                                チェンジトークとは、現状を変えたいという方向へ向かう、相談者自身の発言のことです。これに気づき、引き出すことがMIの鍵となります。チェンジトークは「準備言語」と「実行言語」に分けられます。<br><br>
                                <strong>準備言語 (DARN)</strong> - 変化の準備をしている段階の言葉
                                <ul>
                                    <li><strong>Desire (願望):</strong> 「もっと健康になりたい」「〜したい」</li>
                                    <li><strong>Ability (能力):</strong> 「やろうと思えば、〜できる」「〜できるかもしれない」</li>
                                    <li><strong>Reason (理由):</strong> 「タバコをやめれば、お金が貯まるから」「〜のため」</li>
                                    <li><strong>Need (必要性):</strong> 「〜しないといけない」「〜する必要がある」</li>
                                </ul>
                                <strong>実行言語 (CAT)</strong> - 変化を実行に移そうとしている段階の言葉
                                <ul>
                                    <li><strong>Commitment (決意):</strong> 「明日から、〜します」</li>
                                    <li><strong>Activation (始動):</strong> 「〜する準備はできています」「〜に取り掛かろうと思う」</li>
                                    <li><strong>Taking Steps (実行):</strong> 「昨日、実際に〜をやってみました」</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- クイズ画面 -->
        <div id="quiz-screen" class="hidden">
            <div class="header">
                <button class="back-button" onclick="showMainMenu()">戻る</button>
                <h2>用語クイズ</h2>
                <span id="quiz-progress"></span>
            </div>
            <div id="quiz-content">
                <div id="quiz-question-container">
                    <div id="quiz-question"></div>
                    <div id="quiz-options"></div>
                    <div id="quiz-feedback" class="hidden"></div>
                </div>
                <div id="quiz-result" class="hidden"></div>
            </div>
        </div>


        <!-- ゲーム画面 -->
        <div id="game-screen" class="hidden">
            <div class="header">
                 <button class="back-button" onclick="showMainMenu()">戻る</button>
                <h2 id="scenario-title"></h2>
                <div id="score-display">スコア: 0</div>
            </div>
            <div id="chat-log"></div>
            <div id="options-container"></div>
        </div>

    </div>

    <script>
        // DOM要素の取得
        const scenarioSelector = document.getElementById('scenario-selector');
        const gameScreen = document.getElementById('game-screen');
        const studyModeScreen = document.getElementById('study-mode-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const chatLog = document.getElementById('chat-log');
        const optionsContainer = document.getElementById('options-container');
        const scoreDisplay = document.getElementById('score-display');
        const scenarioTitle = document.getElementById('scenario-title');

        // ゲームの状態管理
        let score = 0;
        let currentScenario = null;
        let currentSceneKey = null;

        // シナリオデータ
        const scenarios = {
            jobSeeking: {
                title: "シナリオ1: 就労への不安",
                maxScore: 55,
                start: "start",
                scenes: {
                    "start": {
                        message: "ハローワークには行ってるんですけど、なかなか良い仕事が見つからなくて…。もう、なんだかどうでもよくなっちゃいますよ。",
                        options: [
                            { text: "良い仕事が見つからず、少し気持ちが疲れてしまっているんですね。", mi: "R", score: 10, feedback: "【聞き返し】相手の言葉を繰り返して理解を示し、感情を認める良い応答です。相手は「分かってくれた」と感じ、さらに話しやすくなります。", next: "job_scene2_good" },
                            { text: "「良い仕事」というと、具体的にどんなお仕事のことですか？", mi: "O", score: 5, feedback: "【開かれた質問】相手の考えを深掘りする良い質問です。ただし、相手が疲れている時は質問が負担になる可能性もあります。", next: "job_scene2_neutral" },
                            { text: "もっと真剣に探さないとダメですよ。選り好みしすぎじゃないですか？", mi: "Adv", score: -10, feedback: "【間違い指摘反射】一方的な助言や批判は、相手の抵抗感を生みます。MIでは最も避けるべき対応の一つです。", next: "job_scene2_bad" }
                        ]
                    },
                    "job_scene2_good": {
                        message: "そうなんです…。分かってくれますか。自分でも頑張らないとって思うんですけど、心が折れそうで。",
                        options: [
                            { text: "頑張りたい気持ちと、心が折れそうな気持ちの両方があるんですね。", mi: "R", score: 10, feedback: "【両面性のある聞き返し】相反する気持ちを両方とも認めることで、相手は安心して葛藤を話せます。変化への動機を探る上で非常に効果的です。", next: "job_scene3_good" },
                            { text: "これまでも、大変な中で色々と頑張ってこられたんですね。", mi: "A", score: 10, feedback: "【是認】相手のこれまでの努力を認め、尊重する姿勢を示すことで、自己効力感（やればできるという感覚）を高めることができます。", next: "job_scene3_good" },
                            { text: "ここで諦めたら、ずっとこのままですよ！", mi: "Adv", score: -10, feedback: "【間違い指摘反射】相手を追い詰めるような発言は逆効果です。本人が自ら「変わりたい」と思えるような言葉を引き出すのがMIの目的です。", next: "job_scene2_bad" }
                        ]
                    },
                    "job_scene2_neutral": {
                        message: "うーん…まあ、給料が良くて、安定してて…。そんな仕事、簡単にはないですよね。",
                        options: [
                             { text: "安定した生活を望んでいらっしゃるんですね。", mi: "R", score: 10, feedback: "【聞き返し】相手の言葉の裏にある価値観（安定したい）を汲み取って伝える、一歩進んだ聞き返しです。素晴らしい応答です。", next: "job_scene3_good" },
                             { text: "そうですね、確かに難しいかもしれません。", mi: "Con", score: -5, feedback: "【同調】話が終わってしまい、変化に向けた会話が停滞する可能性があります。MIでは会話を広げ、深めることを目指します。", next: "job_scene2_bad" }
                        ]
                    },
                    "job_scene2_bad": {
                        message: "…そうですよね。すみません、俺が甘いんですよね。",
                        options: [
                            { text: "いえ、そんな風に自分を責めないでください。そう感じてしまうほど、今お辛い状況なんですね。", mi: "R", score: 10, feedback: "【聞き返し】相手の自己否定を否定せず、その背景にある感情に寄り添うことで、再び信頼関係を築くことができます。", next: "job_scene3_good" },
                            { text: "そうですよ。もっと現実を見ないと。", mi: "Adv", score: -10, feedback: "【間違い指摘反射】相手の自己否定に同調し、さらに追い詰めるのは最悪の対応です。相手は心を閉ざしてしまいます。", next: "end_bad" }
                        ]
                    },
                     "job_scene3_good": {
                        message: "はい…。もし、ちゃんと仕事が決まったら、少しは自分のことを認められるのかなって思う時もあって…。",
                        options: [
                            { text: "仕事が決まって、ご自身のことを認められるようになる、というのは素敵な未来ですね。その一方で、何か心配なことはありますか？", mi: "O", score: 10, feedback: "【開かれた質問】変化のメリット（チェンジトーク）を是認しつつ、変化に伴う不安にも目を向けることで、より現実的な計画に繋がります。", next: "job_scene4_good" },
                            { text: "じゃあ、その目標のために頑張りましょう！", mi: "Cheer", score: 0, feedback: "【応援】気持ちは良いですが、具体的な行動に繋がりにくいです。相手の不安要素を先に解消することが大切です。", next: "job_scene4_good" }
                        ]
                    },
                    "job_scene4_good": {
                        message: "やっぱり、また面接で落とされるんじゃないかって…。あの否定される感じが、もう嫌で…。",
                        options: [
                            { text: "面接で否定されるような辛い経験が、次の一歩をためらわせているのですね。", mi: "R", score: 10, feedback: "【感情の聞き返し】相手の行動の裏にある「恐怖」や「辛さ」という感情を汲み取って返すことで、深いレベルでの共感を示せます。", next: "job_scene5_good" },
                            { text: "面接の練習を一緒にしてみるのはどうでしょうか？", mi: "Sol", score: -5, feedback: "【解決策の提案】相手の気持ちを受け止める前に解決策を提示すると、「気持ちを分かってくれていない」と感じさせてしまう可能性があります。", next: "job_scene5_neutral" }
                        ]
                    },
                    "job_scene5_good": {
                        message: "はい…。でも、いつまでもこのままじゃいけないとも思うんです。少しずつでも、前に進まないと…。",
                        options: [
                             { text: "（ここまでを要約して）就職活動がうまくいかず心が折れそうになる一方で、仕事が決まれば自分を認められるという希望もある。ただ、過去の辛い経験から面接への恐怖があるけれど、それでも前に進みたいという強い意志をお持ちなんですね。", mi: "S", score: 15, feedback: "【要約】会話全体をまとめ、相手の葛藤と希望、そして変化への決意を花束のように渡す、MIの重要なスキルです。本人の変化への気づきを促します。", next: "end_good" }
                        ]
                    },
                    "job_scene5_neutral": {
                        message: "練習ですか…。うーん、もう少し、心の準備ができてからでもいいですか…。",
                        options: [
                             { text: "もちろんです。焦る必要はありませんよ。心の準備が大切ですよね。では、今日はまず「前に進みたい」というお気持ちが聞けただけでも、大きな一歩だと思います。", mi: "A", score: 10, feedback: "【是認・自律性の尊重】相手のペースを尊重し、今日の会話の成果を肯定的に伝えることで、次回の面談に繋げることができます。", next: "end_neutral" }
                        ]
                    },
                    "end_good": { systemMessage: "素晴らしい対応でした！相手の中から変化に向けた言葉（チェンジトーク）を引き出すことができました。この調子で、相手の自己決定を尊重し、伴走していきましょう。" },
                    "end_bad": { systemMessage: "相手は心を閉ざしてしまいました。MIでは、まず安心できる関係を築くことが何よりも大切です。もう一度挑戦してみましょう。" },
                    "end_neutral": { systemMessage: "今回は、相手のペースを尊重し、関係を維持することに成功しました。すぐに変化に繋がらなくても、信頼関係を築き続けることが重要です。" }
                }
            },
            finance: {
                title: "シナリオ2: 金銭管理の悩み",
                maxScore: 55,
                start: "start",
                scenes: {
                     "start": {
                        message: "すみません、ケースワーカーさん…。今月もちょっと生活が厳しくて…。前借りみたいなことって、できませんかね…？",
                        options: [
                            { text: "何にお金を使ったか、ちゃんと説明してください。", mi: "Con", score: -10, feedback: "【詰問】相手を問い詰めるような態度は、信頼関係を損ないます。相手は萎縮し、本当のことを話せなくなってしまいます。", next: "fin_scene2_bad" },
                            { text: "今月も大変な状況なのですね。もしよければ、どんなことにお困りか一緒に考えさせていただけませんか？", mi: "O", score: 10, feedback: "【開かれた質問・協働】相手の状況に共感を示し、一方的に助けるのではなく「一緒に考える」という協働的な姿勢が、相手の主体性を尊重する上で非常に重要です。", next: "fin_scene2_good" },
                            { text: "制度上、前借りはできないことになっています。", mi: "Info", score: -5, feedback: "【情報提供】事実は事実ですが、相手の気持ちを無視してルールだけを伝えると、冷たい印象を与え、相談の機会を失う可能性があります。", next: "fin_scene2_bad" }
                        ]
                    },
                    "fin_scene2_good": {
                        message: "いえ、その…自分の使い方が悪いのかなって…。友達付き合いとかで、つい見栄を張っちゃったりして…。",
                        options: [
                             { text: "お友達との関係も大切にされているんですね。", mi: "A", score: 10, feedback: "【是認】行動の背景にある価値観（友人関係を大切にしたい）を認めることで、相手は「自分のことを分かってくれる」と感じ、安心して話せるようになります。", next: "fin_scene3_good" },
                             { text: "見栄を張るのはやめた方がいいですよ。", mi: "Adv", score: -10, feedback: "【間違い指摘反射】正論による助言は、相手の反発を招きます。「そんなことは分かっている」と、心を閉ざしてしまうかもしれません。", next: "fin_scene2_bad" }
                        ]
                    },
                    "fin_scene2_bad": {
                         message: "…そうですよね。すみません、もういいです。",
                         options: [
                              { text: "待ってください。あなたの力になりたいんです。お金のことで困ってしまう今の状況と、本当はどうなりたいか、という点を一緒に話しませんか？", mi: "Dis", score: 10, feedback: "【矛盾を広げる】現状と理想のギャップについて話すことを提案し、会話を立て直そうとする良い試みです。相手が変化を考えるきっかけになります。", next: "fin_scene3_good" },
                              { text: "分かりました。何かあればまた。", mi: "End", score: -5, feedback: "【会話の終了】相手の言葉通りに会話を終えてしまうと、支援の機会を失ってしまいます。もう一歩踏み込むことが大切です。", next: "end_bad" }
                         ]
                    },
                     "fin_scene3_good": {
                         message: "はい…。でも、このままじゃダメだっていうのも分かってるんです。本当は、ちゃんとお金の管理ができるようになりたい。",
                         options: [
                             { text: "「ちゃんとお金の管理ができるようになりたい」というお気持ち、とても大切だと思います。そのお気持ちについて、もう少し詳しく聞かせてもらえますか？", mi: "O", score: 10, feedback: "【開かれた質問】相手から出たチェンジトークを深掘りする質問です。変化への動機をさらに強めることができます。", next: "fin_scene4_good" },
                             { text: "では、今日から家計簿をつけましょう。", mi: "Sol", score: -5, feedback: "【性急な計画】動機が高まったからといって、すぐに具体的な計画に移ると、相手が抵抗を感じることがあります。まずは動機を固めることが重要です。", next: "fin_scene4_bad" }
                         ]
                    },
                    "fin_scene4_good": {
                        message: "なんていうか…お金のことでいつも不安でいるのが嫌なんです。月末に焦ったり、欲しいものを我慢したり…。そういうのじゃなくて、計画的に使えるようになりたいです。",
                        options: [
                            { text: "お金の心配から解放されて、計画的に使えるようになることで、もっと安心して生活できるようになりたい、ということですね。", mi: "R", score: 10, feedback: "【聞き返し】相手の言葉を、その裏にある価値観（安心したい）と結びつけて返すことで、変化の重要性を本人に再認識させることができます。", next: "fin_scene5_good" },
                        ]
                    },
                    "fin_scene4_bad": {
                        message: "家計簿ですか…前もやろうとしたんですけど、続かなくって…。やっぱり自分には無理なのかな…。",
                        options: [
                            { text: "以前挑戦してみたことがあるんですね。それ自体が素晴らしいことです。無理だと決めつけずに、なぜ続かなかったのか、どうすれば続けられそうか、一緒に考えてみませんか？", mi: "A", score: 10, feedback: "【是認と協働】過去の失敗を責めるのではなく、挑戦した事実を是認することで、自己効力感を支えます。「一緒に考える」という姿勢も重要です。", next: "fin_scene4_good" }
                        ]
                    },
                    "fin_scene5_good": {
                        message: "はい、そうです。そのために、自分に何ができるか…。まずは、何にいくら使っているか、把握するところから始めてみようかな。",
                        options: [
                             { text: "素晴らしいですね！ご自身で具体的な第一歩を考えられた。まずは現状を把握することから始める、というのはとても良い計画だと思います。その計画を実行する上で、何か私にお手伝いできることはありますか？", mi: "Sup", score: 15, feedback: "【自己効力感の支持】相手の中から生まれた計画を全面的に支持し、その自律性を尊重する完璧な応答です。支援の申し出も、相手に主導権を渡す形で行えています。", next: "end_good" }
                        ]
                    },
                    "end_good": { systemMessage: "素晴らしい対応でした！相手の中から変化に向けた言葉（チェンジトーク）を引き出すことができました。この調子で、相手の自己決定を尊重し、伴走していきましょう。" },
                    "end_bad": { systemMessage: "相手は心を閉ざしてしまいました。MIでは、まず安心できる関係を築くことが何よりも大切です。もう一度挑戦してみましょう。" }
                }
            },
             elderlyCare: {
                title: "シナリオ3: 施設入居",
                maxScore: 60,
                start: "start",
                scenes: {
                     "start": {
                        message: "息子がね、もう一人暮らしは危ないから、施設に入ったらどうかなんて言うんですよ。でもねぇ、私はこの家が一番なんです。ここで最後まで暮らしたいんですよ。",
                        options: [
                            { text: "このお家にとても愛着があって、ずっとここで暮らしたいというお気持ちが強いのですね。", mi: "R", score: 10, feedback: "【聞き返し】相手の最も強い気持ち（家にいたい）を言葉にして返すことで、深く共感していることを示せます。会話の素晴らしいスタートです。", next: "eld_scene2_good" },
                            { text: "ですが、息子さんも心配されているんですよ。安全が第一ですからね。", mi: "Adv", score: -10, feedback: "【説得・間違い指摘反射】相手の気持ちを脇に置いて正論を伝えても、反発を招くだけです。「私の気持ちを分かってくれない」と思わせてしまいます。", next: "eld_scene2_bad" },
                            { text: "どんな施設が良いか、いくつかパンフレットを持ってきましょうか？", mi: "Sol", score: -5, feedback: "【性急な解決策】相手がまだ気持ちの整理がついていない段階で具体的な提案をしても、受け入れられにくいです。まずは気持ちに寄り添うことが大切です。", next: "eld_scene2_neutral" }
                        ]
                    },
                    "eld_scene2_good": {
                        message: "そうなんです、分かってくれますか。この家の柱には、孫たちの身長を測った傷もあって…。全部、思い出なんですよ。",
                        options: [
                             { text: "このお家には、たくさんの大切な思い出が詰まっているのですね。", mi: "A", score: 10, feedback: "【是認】相手が大切にしている価値観（家族との思い出）を肯定的に認めることで、信頼関係がさらに深まります。", next: "eld_scene3_good" },
                             { text: "思い出は大切ですが、現実も見ないといけません。", mi: "Adv", score: -10, feedback: "【間違い指摘反射】相手の感情を軽視し、正論で対抗しようとしています。これでは対立が深まるだけです。", next: "eld_scene2_bad" }
                        ]
                    },
                     "eld_scene2_neutral": {
                        message: "パンフレットなんて、まだいいですよ…。そんな気にはなれませんから。",
                        options: [
                             { text: "失礼いたしました。まだ施設について考えるお気持ちではないのですね。それよりも、今はこのお家で暮らしたいというお気持ちの方がずっと大きいのですね。", mi: "R", score: 10, feedback: "【謝罪と聞き返し】自分の提案が早すぎたことを認め、相手の気持ちに寄り添い直すことで、会話を軌道修正できます。", next: "eld_scene2_good" }
                        ]
                    },
                     "eld_scene2_bad": {
                         message: "安全、安全って言うけど、心が寂しかったら、安全でも意味ないじゃないですか。",
                         options: [
                              { text: "おっしゃる通りですね。体だけでなく、心の安全も同じくらい大切ですよね。このお家にいることが、あなたの心の拠り所になっているのですね。", mi: "R", score: 10, feedback: "【抵抗に寄り添う】相手の反論に同意し、その言葉の裏にある感情を汲み取ることで、対立から協働へと関係を転換させることができます。", next: "eld_scene3_good" }
                         ]
                    },
                     "eld_scene3_good": {
                         message: "はい…。でも、最近は少し、不安なこともあるんです。夜中にトイレに起きる時、ふらついたりして…。この前も、お鍋を火にかけたのを忘れちゃって。",
                         options: [
                             { text: "この家で暮らし続けたいという強い気持ちがある一方で、最近はご自身の体のことや火の元など、少し心配なことも出てきたのですね。", mi: "R", score: 15, feedback: "【両面性のある聞き返し】家にいたい気持ちと、暮らしへの不安。この二つの相反する気持ち（アンビバレンス）を提示することで、ご本人が自分の状況を客観的に見つめる手助けをします。", next: "eld_scene4_good" }
                         ]
                    },
                    "eld_scene4_good": {
                        message: "そうなのよ…。だから、息子が心配する気持ちも、分からなくはないんです。迷惑はかけたくないしねぇ。",
                        options: [
                            { text: "ご自身の安全ももちろんですが、息子さんに心配をかけたくないというお気持ちもあるのですね。", mi: "A", score: 10, feedback: "【是認】相手の言葉から、その人が大切にしている価値観（息子への愛情）を見つけ出して伝えることで、変化への動機が強まります。", next: "eld_scene5_good" },
                        ]
                    },
                    "eld_scene5_good": {
                        message: "ええ…。この家で安全に、そして息子にも心配をかけずに暮らしていくために、何か良い方法があればいいんだけど…。",
                        options: [
                             { text: "（要約）この思い出深い家で最後まで暮らしたいという強いお気持ちと、ご自身の安全やご家族を思う気持ちの両方をお持ちなのですね。その二つを両立できるような、何か良い方法をこれから一緒に考えていきませんか。", mi: "S", score: 15, feedback: "【要約と協働の提案】これまでの会話をまとめ、本人の複雑な気持ちを整理した上で、未来に向けた話し合いを提案する、理想的な流れです。すぐに結論を出さず、「一緒に考える」という姿勢が重要です。", next: "end_good" }
                        ]
                    },
                    "end_good": { systemMessage: "素晴らしい対応でした！相手の複雑な気持ちに寄り添い、変化に向けた協働関係を築くことができました。すぐに答えを出すのではなく、本人のペースで考える時間を作ることが大切です。" },
                    "end_bad": { systemMessage: "相手は心を閉ざしてしまいました。MIでは、まず安心できる関係を築くことが何よりも大切です。もう一度挑戦してみましょう。" }
                }
            }
        };

        // クイズデータ
        const allQuizData = [
            {
                question: "MIの基本姿勢「PACE」のうち、支援者と相談者は対等なパートナーであるという考え方を示すものはどれ？",
                options: ["Partnership (協働)", "Acceptance (受容)", "Compassion (思いやり)", "Evocation (喚起)"],
                correctAnswer: "Partnership (協働)",
                explanation: "Partnership (協働)は、専門家とクライアントという上下関係ではなく、対等な立場で一緒にゴールを目指す姿勢を指します。"
            },
            {
                question: "MIのスキル「OARS」のうち、「相手の長所や努力を言葉にして伝える」ことはどれ？",
                options: ["開かれた質問 (Open questions)", "是認 (Affirming)", "聞き返し (Reflecting)", "要約 (Summarizing)"],
                correctAnswer: "是認 (Affirming)",
                explanation: "是認 (Affirming)は、相手の強みや肯定的な側面を認め、伝えることで、自己効力感を高める重要なスキルです。"
            },
            {
                question: "MIの4つのプロセスのうち、相談者自身の「変わりたい」という動機を引き出す、MIの心臓部とも言える段階はどれ？",
                options: ["関わる (Engaging)", "焦点化する (Focusing)", "引き出す (Evoking)", "計画する (Planning)"],
                correctAnswer: "引き出す (Evoking)",
                explanation: "引き出す (Evoking)プロセスでは、チェンジトークに耳を傾け、それを引き出すことで、本人の内的な動機を高めていきます。"
            },
            {
                question: "チェンジトークの準備言語「DARN」に含まれないものはどれ？",
                options: ["願望 (Desire)", "能力 (Ability)", "決意 (Commitment)", "理由 (Reason)"],
                correctAnswer: "決意 (Commitment)",
                explanation: "決意 (Commitment)は、変化を実際に行動に移そうとする「実行言語(CAT)」の一部です。DARNは変化の準備段階の言葉です。"
            },
            {
                question: "相談者の発言を別の言葉で言い換えたり、その裏にある感情を汲み取って返すスキルは、OARSのうちどれ？",
                options: ["開かれた質問 (Open questions)", "是認 (Affirming)", "聞き返し (Reflecting)", "要約 (Summarizing)"],
                correctAnswer: "聞き返し (Reflecting)",
                explanation: "聞き返し (Reflecting)は、相手に「理解してもらえている」という感覚を与え、さらに深い内省を促すための中心的なスキルです。"
            },
            {
                question: "PACEの基本姿勢のうち、「変化への動機や答えは本人の中にある」という考え方を示すものはどれ？",
                options: ["Partnership (協働)", "Acceptance (受容)", "Compassion (思いやり)", "Evocation (喚起)"],
                correctAnswer: "Evocation (喚起)",
                explanation: "Evocation (喚起)は、答えを外から与えるのではなく、本人が元々持っている知識や動機、価値観を「引き出す（呼び起こす）」という姿勢を指します。"
            },
            {
                question: "「はい／いいえ」で終わらない質問を投げかけ、相手が自由に話せるようにするスキルはOARSのうちどれ？",
                options: ["開かれた質問 (Open questions)", "是認 (Affirming)", "聞き返し (Reflecting)", "要約 (Summarizing)"],
                correctAnswer: "開かれた質問 (Open questions)",
                explanation: "開かれた質問 (Open questions)は、5W1H（いつ、どこで、誰が、何を、なぜ、どのように）を使って質問し、相手から多くの情報を引き出すことを目的とします。"
            },
            {
                question: "MIの4つのプロセスのうち、最初に信頼関係を築く段階はどれ？",
                options: ["関わる (Engaging)", "焦点化する (Focusing)", "引き出す (Evoking)", "計画する (Planning)"],
                correctAnswer: "関わる (Engaging)",
                explanation: "関わる (Engaging)は、全てのプロセスの土台です。安心・安全な雰囲気の中で、協力的な関係を築くことが最も重要です。"
            },
            {
                question: "「昨日、ハローワークのサイトを見てみました」という発言は、チェンジトークのどの種類に最も当てはまる？",
                options: ["願望 (Desire)", "能力 (Ability)", "決意 (Commitment)", "実行 (Taking Steps)"],
                correctAnswer: "実行 (Taking Steps)",
                explanation: "実行 (Taking Steps)は、変化に向けて既に具体的な行動を起こしたことを示す、非常に強力なチェンジトークです。"
            },
            {
                question: "会話の内容をまとめ、相手に確認することで、会話の方向性を共有したり、チェンジトークを強調したりするスキルはOARSのうちどれ？",
                options: ["開かれた質問 (Open questions)", "是認 (Affirming)", "聞き返し (Reflecting)", "要約 (Summarizing)"],
                correctAnswer: "要約 (Summarizing)",
                explanation: "要約 (Summarizing)は、会話の節目で使われ、相手の考えを整理する手助けをすると同時に、次のステップへ進むための橋渡しの役割を果たします。"
            },
            {
                question: "相談者が「でも」「だって」と反論してきた時の、MIとしてより適切な対応はどれ？",
                options: ["さらに強い言葉で説得する", "反論に同意し、その気持ちを認める", "話題を変える", "面接を打ち切る"],
                correctAnswer: "反論に同意し、その気持ちを認める",
                explanation: "MIでは、抵抗（反論）は対立するものではなく、相手の気持ちの表れと捉えます。その気持ちに寄り添う（Roll with Resistance）ことで、対立を避け、協働関係を維持します。"
            },
            {
                question: "チェンジトークの実行言語「CAT」に含まれないものはどれ？",
                options: ["決意 (Commitment)", "始動 (Activation)", "実行 (Taking Steps)", "必要性 (Need)"],
                correctAnswer: "必要性 (Need)",
                explanation: "必要性 (Need)は、「〜しなければならない」という変化の準備段階の言葉であり、「準備言語(DARN)」の一部です。"
            },
            {
                question: "「変わりたい気持ちと、変わりたくない気持ちの両方があるんですね」という聞き返しを、特に何と呼びますか？",
                options: ["単純な聞き返し", "感情の聞き返し", "両面性のある聞き返し", "要約"],
                correctAnswer: "両面性のある聞き返し",
                explanation: "両面性のある聞き返しは、相談者のアンビバレンス（両価性）をそのまま言葉にして返すことで、本人が葛藤を客観的に見つめる手助けとなります。"
            },
            {
                question: "相談者が自分で目標や計画を立てた時、支援者の最も適切な応答はどれ？",
                options: ["「もっと高い目標を設定しましょう」と促す", "「その計画には欠点があります」と指摘する", "「ご自身で考えられて素晴らしいですね」と支持する", "「私が考えた計画の方が良いです」と提案する"],
                correctAnswer: "「ご自身で考えられて素晴らしいですね」と支持する",
                explanation: "相談者の自己決定権を尊重し、自己効力感を支持することが重要です。本人が立てた計画を肯定し、その実行をサポートする姿勢が求められます。"
            },
            {
                question: "MIの精神（スピリット）に反する行動はどれ？",
                options: ["相談者のペースを尊重する", "相談者の良い点を探して伝える", "専門家として一方的に指導する", "相談者と一緒に解決策を探す"],
                correctAnswer: "専門家として一方的に指導する",
                explanation: "一方的な指導は、専門家とクライアントという上下関係（不均衡な権力関係）を生み出し、MIの基本である協働（Partnership）の精神に反します。"
            },
             {
                question: "相談者が「自分には無理です」と言った時、MIとして不適切な応答はどれ？",
                options: ["「無理だと感じていらっしゃるのですね」と聞き返す", "「以前、似たようなことを乗り越えた経験はありませんか？」と質問する", "「そんな弱気でどうするんですか！」と叱咤激励する", "「無理だと感じる点について、もう少し詳しく教えていただけますか？」と質問する"],
                correctAnswer: "「そんな弱気でどうするんですか！」と叱咤激励する",
                explanation: "叱咤激励は一見、相手のためを思っているようですが、相手の無力感を否定し、追い詰めることになりかねません。まずは相手の気持ちを受け止めることが重要です。"
            },
             {
                question: "MIの４つのプロセスのうち、「今日は何について話しましょうか？」と尋ね、会話の方向性を決める段階はどれ？",
                options: ["関わる (Engaging)", "焦点化する (Focusing)", "引き出す (Evoking)", "計画する (Planning)"],
                correctAnswer: "焦点化する (Focusing)",
                explanation: "焦点化する (Focusing)プロセスでは、多岐にわたる可能性の中から、相談者と支援者が合意の上で、取り組むべきテーマを絞り込んでいきます。"
            },
             {
                question: "「もし変化がうまくいったら、どんないいことがありますか？」という質問の主な目的は？",
                options: ["相手をテストするため", "相手の知識を確認するため", "チェンジトークを引き出すため", "維持トークを引き出すため"],
                correctAnswer: "チェンジトークを引き出すため",
                explanation: "この質問は、変化した後のポジティブな未来を想像させ、変化の「理由」や「願望」といったチェンジトークを語るよう促す、典型的な誘い水です。"
            },
             {
                question: "「あなたは強い人ですね」という是認よりも、MIで推奨される是認はどれ？",
                options: ["「あなたは優しいですね」", "「あなたは頭が良いですね」", "「大変な中でも、諦めずによく頑張りましたね」", "「あなたは正しいですね」"],
                correctAnswer: "「大変な中でも、諦めずによく頑張りましたね」",
                explanation: "MIの是認では、漠然とした性格への評価よりも、具体的な行動や努力に対して焦点を当てて伝える方が、相手の自己効力感を高める上でより効果的です。"
            },
             {
                question: "「変わりたくない」という方向の言葉を何と呼びますか？",
                options: ["チェンジトーク", "維持トーク", "ディスコース", "スモールトーク"],
                correctAnswer: "維持トーク",
                explanation: "維持トークは、現状維持を望む発言のことです。MIでは維持トークを否定せず、その裏にある気持ちを理解しようと努めながら、チェンジトークとのバランスを探ります。"
            }
        ];
        
        // クイズの状態管理
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let quizScore = 0;
        const quizQuestionContainer = document.getElementById('quiz-question-container');
        const quizQuestionEl = document.getElementById('quiz-question');
        const quizOptionsEl = document.getElementById('quiz-options');
        const quizFeedbackEl = document.getElementById('quiz-feedback');
        const quizResultEl = document.getElementById('quiz-result');
        const quizProgressEl = document.getElementById('quiz-progress');

        
        // --- 画面切り替え ---
        function showMainMenu() {
            scenarioSelector.classList.remove('hidden');
            studyModeScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
        }

        function showStudyMode() {
            scenarioSelector.classList.add('hidden');
            studyModeScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
        }

        function showQuizScreen() {
            scenarioSelector.classList.add('hidden');
            studyModeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            startQuiz();
        }


        // ゲーム開始処理
        function startRandomScenario() {
            const scenarioKeys = Object.keys(scenarios);
            const randomKey = scenarioKeys[Math.floor(Math.random() * scenarioKeys.length)];
            startGame(randomKey);
        }
        
        function startGame(scenarioKey) {
            currentScenario = scenarios[scenarioKey];
            currentSceneKey = currentScenario.start;
            score = 0;
            
            scenarioSelector.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            chatLog.innerHTML = '';
            updateScore(0);
            scenarioTitle.textContent = currentScenario.title;

            displayScene(currentSceneKey);
        }

        // シーン表示処理
        function displayScene(sceneKey) {
            const scene = currentScenario.scenes[sceneKey];
            optionsContainer.innerHTML = '';

            if (scene.message) {
                // クライアントのメッセージを表示
                addMessageToLog(scene.message, 'client');
            }
            
            if (scene.systemMessage) {
                // システムメッセージ（結果）を表示
                addMessageToLog(scene.systemMessage, 'system');
                // やり直しボタンを表示
                const restartButton = createOptionButton({ text: "メインメニューに戻る", next: "restart" });
                optionsContainer.appendChild(restartButton);
                return;
            }

            // 選択肢ボタンを生成
            scene.options.forEach(option => {
                const button = createOptionButton(option);
                optionsContainer.appendChild(button);
            });
        }
        
        // 選択肢ボタン作成ヘルパー
        function createOptionButton(option) {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.textContent = option.text;
            button.onclick = () => selectOption(option);
            return button;
        }

        // 選択肢選択時の処理
        function selectOption(option) {
            if (option.next === 'restart') {
                gameScreen.classList.add('hidden');
                showMainMenu();
                return;
            }

            // プレイヤーの選択を表示
            addMessageToLog(option.text, 'player');

            // ボタンを無効化
            const buttons = optionsContainer.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.disabled = true);
            
            // スコアとフィードバックを遅れて表示
            setTimeout(() => {
                if(option.score !== undefined) {
                    updateScore(option.score);
                    const scoreText = option.score > 0 ? `+${option.score}` : `${option.score}`;
                    const scoreClass = option.score > 0 ? 'plus' : 'minus';
                    const feedbackHTML = `<div class='mi-skill'>${option.feedback}</div><div class='score ${scoreClass}'>スコア: ${scoreText}</div>`;
                    addMessageToLog(feedbackHTML, 'feedback');
                }
                
                // 次のシーンへ
                currentSceneKey = option.next;
                if (currentSceneKey) {
                     setTimeout(() => displayScene(currentSceneKey), 1000);
                }
            }, 500);
        }

        // メッセージをチャットログに追加
        function addMessageToLog(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = content; // innerHTMLを使ってHTMLタグを解釈させる
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // スコア更新
        function updateScore(points) {
            if (points) {
                score += points;
            }
            const maxScore = currentScenario ? currentScenario.maxScore : '';
            scoreDisplay.textContent = `スコア: ${score} / ${maxScore}`;
        }

        // --- クイズ機能 ---
        function startQuiz() {
            // クイズデータをシャッフルして、最初の5問を選択
            const shuffledQuizData = [...allQuizData].sort(() => 0.5 - Math.random());
            currentQuizQuestions = shuffledQuizData.slice(0, 5);

            currentQuestionIndex = 0;
            quizScore = 0;
            quizResultEl.classList.add('hidden');
            quizQuestionContainer.classList.remove('hidden');
            displayQuizQuestion();
        }

        function displayQuizQuestion() {
            quizFeedbackEl.classList.add('hidden');
            quizOptionsEl.innerHTML = '';
            
            const questionData = currentQuizQuestions[currentQuestionIndex];
            quizQuestionEl.textContent = questionData.question;
            quizProgressEl.textContent = `問題 ${currentQuestionIndex + 1} / ${currentQuizQuestions.length}`;
            
            questionData.options.forEach(optionText => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = optionText;
                button.onclick = () => selectQuizAnswer(optionText, questionData.correctAnswer, questionData.explanation);
                quizOptionsEl.appendChild(button);
            });
        }
        
        function selectQuizAnswer(selectedOption, correctAnswer, explanation) {
            const buttons = quizOptionsEl.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                quizScore++;
                quizFeedbackEl.innerHTML = `<strong>正解！</strong><br>${explanation}`;
                quizFeedbackEl.className = 'correct';
            } else {
                quizFeedbackEl.innerHTML = `<strong>不正解…</strong> 正解は「${correctAnswer}」です。<br>${explanation}`;
                quizFeedbackEl.className = 'incorrect';
            }
            quizFeedbackEl.classList.remove('hidden');

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < currentQuizQuestions.length) {
                    displayQuizQuestion();
                } else {
                    showQuizResult();
                }
            }, 2500);
        }
        
        function showQuizResult() {
            quizQuestionContainer.classList.add('hidden');
            quizResultEl.classList.remove('hidden');
            quizResultEl.innerHTML = `
                <h3>クイズ終了！</h3>
                <p>${currentQuizQuestions.length}問中 ${quizScore}問 正解！</p>
                <button class="option-button" onclick="startQuiz()">もう一度挑戦する</button>
            `;
        }


        // Accordion functionality
        const accordionItems = document.querySelectorAll('.accordion-item');
        accordionItems.forEach(item => {
            const header = item.querySelector('.accordion-header');
            const content = item.querySelector('.accordion-content');
            header.addEventListener('click', () => {
                const isActive = item.classList.contains('active');
                
                // Close all items
                accordionItems.forEach(i => {
                    i.classList.remove('active');
                    i.querySelector('.accordion-content').style.maxHeight = null;
                });

                // Open the clicked one if it wasn't active
                if (!isActive) {
                    item.classList.add('active');
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });

    </script>
</body>
</html>

